apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cleanup
  namespace: sn-labs-santos321lol
spec:
  description: Clean the workspace.
  workspaces:
    - name: source
  steps:
    - name: remove
      image: alpine:3
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env sh
        set -eu
        rm -rf "${PWD:?}"/* "${PWD}"/.[!.]* "${PWD}"/..?* || true

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: nose
  namespace: sn-labs-santos321lol
spec:
  workspaces:
    - name: source
  params:
    - name: args
      type: string
      default: "-v --with-spec --spec-color --with-coverage --cover-package=app"
  steps:
    - name: nosetests
      image: python:3.9-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt -vv
        pip install nose coverage nose-spec
        nosetests $(params.args)

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: flake8
  namespace: sn-labs-santos321lol
spec:
  workspaces:
    - name: source
  params:
    - name: path
      type: string
      default: "service"
    - name: args
      type: array
      default:
        - "--max-line-length=127"
        - "--statistics"
  steps:
    - name: lint
      image: python:3.9-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt -vv
        pip install flake8
        flake8 $(params.path) --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 $(params.path) "${@}"
